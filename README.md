# btcpayserver-tunnel

opinionated docker container deployment • btcpayserver with cloudflared • arm64 compatible

## Quick Start Instructions

* download zip or tarball, or git clone this repository to the system where you will deploy payserver

* alternatively, just curl or wget the docker-compose.yml file to the system that you want to deploy payserver on

* `wget https://raw.github.com/path.... `

* Review the `.env-template` file.

* create a `.env` file in the same directory where the docker-compose.yml file is located.

* `cp .env-template .env`

* add the correct values to the .env file.

* This deployment assumes that you need to deploy a prunned bitcoin-core node that uses around 30GB, so the sync will take some time.  

The setting for this is in docker-compose.yml  
`-prune=15000`

You'll need sufficient disk space available for the prunned blockchain, so plan accordingly.  

Note - Payserver is not going to work correctly until NBXplorer and the bitcoin core node are in a functional state.  
It could take a few days for those components to be functional.

```shell
docker compose up -d  

docker ps -a
```

## Componets in this Deployment

the first 2 componets are for the Payserver to be public reachable by admins, customers or billing systems.  

| Image                           | Functionality                                     |  Notes
|---------------------------------|---------------------------------------------------|--------------------------------------|
| `btcpayserver/btcpayserver:`    | Admin control and invoice generator               |                                      |
| `cloudflare/cloudflared:latest` | Tunnel payserver into Public CF CDN               |                                      |
| `nicolasdorier/nbxplorer:`      | Monitor addresses generated by invoices           |https://github.com/dgarage/nbxplorer |
| `postgres:16`                   | Required by payserver to manage state of invoices |                                      |
| `dobtc/bitcoin:`                | Required by NBXplorer                             |https://github.com/dobtc/bitcoin      |
| `lightninglabs/lnd:`            | Optional Lightning Network Support                |                                      |

the last 4 components are required for the functinality of Payserver.  

https://github.com/dgarage/nbxplorer seems to be linked to image nicolasdorier/nbxplorer

Since btcpayserver supports other blockchains, you can add others to your deployment as desired inside the docker compose file.


## https: global redirect rule for your domain

> Note: You could also add a container for https reverse proxy, wired to the payserver container, then connect the CF Tunnel to the https proxy, but the goal of this is to move faster and reduce un-needed complexity.  

Additionally, Cloudflare gives some nice options that you need to review in their dashboard:  

`Current applied mode: Full (strict)` for all SSL/TLS traffic. 

`Strict (SSL-Only Origin Pull)` for enterprise customers.

At this time I just recommend to add a Redirect Rule at the domain level.  
`http -> https`

You probably want this anyway, and avoids complexity in your deployment with self-signed or Lets Encrypt Certs.  

Cloudflare has a ready-to-go template for this in their dashboard:

![configure redirects at the domain level](/documentation/tunnel-example-03.png)

![active redirect](/documentation/redirect-active-example.png)


## Cloudflare Network Plumbing

The only thing that cloudflared needs to access for proper public access is the payserver container.  
However, it's important that all components here are inside the same docker network for correct functionality.  
This is important if the system where you do this deployment is also going to have other docker related deployments for other services.  

Here we use a docker network name:  
```
    networks:
      - btcpayserver
```
> Therefore, no other deployments on your system will be using the same network name, and you can run as many cloudflared tunnels as needed on the same system as long as each is in its own docker network.


## Motivations for this project

When I read the official BTCPayserver Documentation and related git repos, e.g. the docker related repo, 
all I found was a bunch of weird "generate docker compose" scripts that did things I did not want the scripts to do.  
And I could not get them to run properly.

For starters, the scripts assumed that docker engine was not installed.

Since I have a slightly custom setup for docker engine, I don't want to use any scripts that will try to install something I alread have installed.

The official repos "generate scripts" seem highly targeted to non-technical users.

Additionally, the CF Tunnel related docs are a good primer, but not up no date for 2025:  
https://docs.btcpayserver.org/Docker/cloudflare-tunnel/


## Why use this vs the community 'generate' scripts?

* The community scripts seemed messy / non-useable when I evaluated in July 2025.

* You just want a functional docker-compose file that works out-of-the-box to get payserver running.

* This is an opinionated container deployment which assumes that you want to run a pruned bitcoin core node 
on the same hardware or VM as where you want to run the other required items for Payserver to function.

* Assumes that you are going to make your Payserver a public facing deployment via a Cloudflare Tunnel  
(this projects name also implies this)

* Pre-existing knowldege about the basics of `cloudflared` and CF Tunnels is very helpful, but not required.

* The CF Tunnel will slightly abstract the location of where your Payserver is deployed, and also make it available on the Global Cloudflare CDN.

* Cloudflare will auto-magically create the correct public `A` and `AAAA` records **for you** when you plumb your desired Public Hostname to your payserver container. (I usually do this in the dashboard)

* Below are some screenshots of what that typically looks like in the dashboard:

## Cloudflare Tunnel Dashboard Screenshots 

![public hostname you want clients/customers to reach](/documentation/tunnel-example-01.png)

![plumb the container port 23000 to the public hostname](/documentation/tunnel-example-02.png)


## Acknowledgments

Thanks to all BTCpayserver core team members and contributers
